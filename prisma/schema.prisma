// Prisma Schema para MariaDB - Asesoría La Llave
// Provider: MySQL (compatible con MariaDB 10.11+)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
enum ClientType {
  AUTONOMO
  EMPRESA
  PARTICULAR
}

enum TaskPriority {
  BAJA
  MEDIA
  ALTA
}

enum TaskStatus {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
}

enum TaskVisibility {
  GENERAL
  PERSONAL
}

enum ManualStatus {
  DRAFT
  PUBLISHED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum BackupStatus {
  CREATING
  COMPLETED
  FAILED
  RESTORING
  RESTORED
}

enum UpdateStatus {
  CHECKING
  BACKING_UP
  DOWNLOADING
  INSTALLING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum StorageType {
  LOCAL
  FTP
  SMB
}

enum Periodicidad {
  MENSUAL
  TRIMESTRAL
  ANUAL
}

enum EstadoDeclaracion {
  PENDIENTE
  CALCULADO
  PRESENTADO
}

enum TipoNotificacion {
  SOLICITUD_INFO
  CONFIRMACION_PRESENTACION
}

// ==================== ROLES & PERMISSIONS ====================
model Role {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  isSystem    Boolean  @default(false) @map("is_system") // true para roles migrados (Admin, Gestor, Lectura)
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.DateTime(3)

  // Relations
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid()) @db.VarChar(36)
  resource    String   @db.VarChar(50) // "clients", "taxes", "tasks", "manuals", "users", "admin"
  action      String   @db.VarChar(50) // "create", "read", "update", "delete", "export", "upload", etc.
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(3)

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid()) @db.VarChar(36)
  roleId       String   @map("role_id") @db.VarChar(36)
  permissionId String   @map("permission_id") @db.VarChar(36)
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(3)

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ==================== USERS & AUTH ====================
model User {
  id        String   @id @default(uuid()) @db.VarChar(36)
  username  String   @unique @db.VarChar(191)
  email     String   @unique @db.VarChar(191)
  password  String   @db.Text
  roleId    String?  @map("role_id") @db.VarChar(36) // Relación con tabla Role
  isActive  Boolean  @default(true) @map("is_active") // Usuario activo o deshabilitado
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(3)

  // Relations
  role            Role?           @relation(fields: [roleId], references: [id], onDelete: SetNull)
  clientsManaged  Client[]        @relation("ClientManager")
  clientsAssigned ClientEmployee[] @relation("ClientEmployees")
  tasksAssigned   Task[]          @relation("TaskAssignee")
  manualsAuthored Manual[]        @relation("ManualAuthor")
  activityLogs    ActivityLog[]
  auditTrails     AuditTrail[]
  smtpAccountsCreated SMTPAccount[]           @relation("SMTPCreator")
  notificationTemplatesCreated NotificationTemplate[] @relation("TemplateCreator")
  notificationsSent NotificationLog[]         @relation("NotificationSender")
  scheduledNotificationsCreated ScheduledNotification[] @relation("ScheduledNotificationCreator")
  backupsCreated  SystemBackup[]  @relation("BackupCreator")
  updatesInitiated SystemUpdate[] @relation("UpdateInitiator")

  @@index([roleId])
  @@map("users")
}

// ==================== CLIENTS ====================
model Client {
  id                  String    @id @default(uuid()) @db.VarChar(36)
  razonSocial         String    @map("razon_social") @db.Text
  nifCif              String    @unique @map("nif_cif") @db.VarChar(191)
  tipo                ClientType
  email               String?   @db.Text
  telefono            String?   @db.Text
  direccion           String?   @db.Text
  fechaAlta           DateTime  @default(now()) @map("fecha_alta") @db.DateTime(3)
  fechaBaja           DateTime? @map("fecha_baja") @db.DateTime(3) // NULL = cliente activo
  responsableAsignado String?   @map("responsable_asignado") @db.VarChar(36)
  taxModels           Json?     @map("tax_models") // Array de modelos fiscales: ["303", "390", "130", "131"]
  isActive            Boolean   @default(true) @map("is_active") // Cliente activo o deshabilitado

  // Relations
  responsable         User?                  @relation("ClientManager", fields: [responsableAsignado], references: [id], onDelete: SetNull)
  tasks               Task[]
  employees           ClientEmployee[]
  clientTaxes         clientTax[]
  clientTaxRequirements clientTaxRequirement[]
  taxFilings          clientTaxFiling[]
  obligacionesFiscales ObligacionFiscal[]
  notificaciones      Notificacion[]

  @@index([responsableAsignado])
  @@index([tipo])
  @@index([isActive])
  @@index([fechaBaja])
  @@map("clients")
}

// ==================== CLIENT EMPLOYEES (Many-to-Many) ====================
model ClientEmployee {
  clientId   String   @map("client_id") @db.VarChar(36)
  userId     String   @map("user_id") @db.VarChar(36)
  isPrimary  Boolean  @default(false) @map("is_primary")
  assignedAt DateTime @default(now()) @map("assigned_at") @db.DateTime(3)

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation("ClientEmployees", fields: [userId], references: [id], onDelete: Cascade)

  @@id([clientId, userId])
  @@index([userId])
  @@index([clientId])
  @@map("client_employees")
}

// ==================== TASKS ====================
model Task {
  id                  String         @id @default(uuid()) @db.VarChar(36)
  titulo              String         @db.Text
  descripcion         String?        @db.Text
  clienteId           String?        @map("cliente_id") @db.VarChar(36)
  asignadoA           String?        @map("asignado_a") @db.VarChar(36)
  prioridad           TaskPriority   @default(MEDIA)
  estado              TaskStatus     @default(PENDIENTE)
  visibilidad         TaskVisibility @default(GENERAL)
  fechaVencimiento    DateTime?      @map("fecha_vencimiento") @db.DateTime(3)
  fechaCreacion       DateTime       @default(now()) @map("fecha_creacion") @db.DateTime(3)
  fechaActualizacion  DateTime       @updatedAt @map("fecha_actualizacion") @db.DateTime(3)

  // Relations
  cliente  Client? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  asignado User?   @relation("TaskAssignee", fields: [asignadoA], references: [id], onDelete: SetNull)

  @@index([visibilidad])
  @@index([asignadoA])
  @@index([clienteId, estado])
  @@index([fechaVencimiento])
  @@map("tasks")
}

// ==================== MANUALS ====================
model Manual {
  id                  String       @id @default(uuid()) @db.VarChar(36)
  titulo              String       @db.Text
  contenidoHtml       String       @map("contenido_html") @db.Text
  autorId             String       @map("autor_id") @db.VarChar(36)
  etiquetas           String?      @db.Text // JSON array stored as text
  categoria           String?      @db.VarChar(191)
  status              ManualStatus @default(DRAFT)
  fechaCreacion       DateTime     @default(now()) @map("fecha_creacion") @db.DateTime(3)
  fechaActualizacion  DateTime     @updatedAt @map("fecha_actualizacion") @db.DateTime(3)
  fechaPublicacion    DateTime?    @map("fecha_publicacion") @db.DateTime(3)

  // Relations
  autor       User              @relation("ManualAuthor", fields: [autorId], references: [id], onDelete: Cascade)
  attachments ManualAttachment[]
  versions    ManualVersion[]

  @@index([status])
  @@index([categoria])
  @@index([autorId])
  @@map("manuals")
}

// ==================== MANUAL ATTACHMENTS ====================
model ManualAttachment {
  id               String   @id @default(uuid()) @db.VarChar(36)
  manualId         String   @map("manual_id") @db.VarChar(36)
  fileName         String   @map("file_name") @db.VarChar(255)
  originalName     String   @map("original_name") @db.VarChar(255)
  filePath         String   @map("file_path") @db.Text
  fileType         String   @map("file_type") @db.VarChar(100)
  fileSize         Int      @map("file_size") // bytes
  uploadedBy       String   @map("uploaded_by") @db.VarChar(36)
  uploadedAt       DateTime @default(now()) @map("uploaded_at") @db.DateTime(3)

  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)

  @@index([manualId])
  @@map("manual_attachments")
}

// ==================== MANUAL VERSIONS ====================
model ManualVersion {
  id             String   @id @default(uuid()) @db.VarChar(36)
  manualId       String   @map("manual_id") @db.VarChar(36)
  versionNumber  Int      @map("version_number")
  titulo         String   @db.Text
  contenidoHtml  String   @map("contenido_html") @db.Text
  etiquetas      String?  @db.Text
  categoria      String?  @db.VarChar(191)
  createdBy      String   @map("created_by") @db.VarChar(36)
  createdAt      DateTime @default(now()) @map("created_at") @db.DateTime(3)

  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)

  @@unique([manualId, versionNumber])
  @@index([manualId])
  @@index([createdAt])
  @@map("manual_versions")
}

// ==================== ACTIVITY LOGS ====================
model ActivityLog {
  id        String   @id @default(uuid()) @db.VarChar(36)
  usuarioId String   @map("usuario_id") @db.VarChar(36)
  accion    String   @db.Text
  modulo    String   @db.VarChar(191)
  detalles  String?  @db.Text
  fecha     DateTime @default(now()) @db.DateTime(3)

  // Relations
  usuario User @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, modulo, fecha])
  @@map("activity_logs")
}

// ==================== AUDIT TRAIL ====================
model AuditTrail {
  id             String      @id @default(uuid()) @db.VarChar(36)
  usuarioId      String      @map("usuario_id") @db.VarChar(36)
  accion         AuditAction
  tabla          String      @db.VarChar(191)
  registroId     String      @map("registro_id") @db.VarChar(36)
  valorAnterior  String?     @map("valor_anterior") @db.Text
  valorNuevo     String?     @map("valor_nuevo") @db.Text
  cambios        String?     @db.Text
  requestId      String?     @map("request_id") @db.VarChar(191)
  fecha          DateTime    @default(now()) @db.DateTime(3)

  // Relations
  usuario User @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([tabla, registroId])
  @@index([fecha])
  @@map("audit_trail")
}

// ==================== SMTP CONFIG ====================
model SmtpConfig {
  id       String  @id @default(uuid()) @db.VarChar(36)
  host     String  @db.VarChar(191)
  port     Int
  user     String  @db.VarChar(191)
  password String  @db.Text
  secure   Boolean @default(false)

  @@map("smtp_config")
}

// ==================== JOB RUNS (CRON TRACKING) ====================
model JobRun {
  id             String   @id @default(uuid()) @db.VarChar(36)
  jobName        String   @map("job_name") @db.VarChar(191)
  startedAt      DateTime @map("started_at") @db.DateTime(3)
  completedAt    DateTime? @map("completed_at") @db.DateTime(3)
  status         String   @db.VarChar(50) // SUCCESS, FAILED, RUNNING
  recordsProcessed Int?   @map("records_processed")
  errorMessage   String?  @map("error_message") @db.Text
  metadata       String?  @db.Text // JSON metadata

  @@index([jobName, startedAt])
  @@index([status])
  @@map("job_runs")
}

// ==================== SYSTEM SETTINGS ====================
model SystemSettings {
  id                   String   @id @default(uuid()) @db.VarChar(36)
  registrationEnabled  Boolean  @default(true) @map("registration_enabled")
  updatedAt            DateTime @updatedAt @map("updated_at") @db.DateTime(3)

  @@map("system_settings")
}

// ==================== NOTIFICATIONS SYSTEM ====================
// Múltiples cuentas SMTP
model SMTPAccount {
  id             String   @id @default(uuid()) @db.VarChar(36)
  nombre         String   @db.VarChar(191)
  host           String   @db.VarChar(191)
  port           Int
  user           String   @db.VarChar(191) // Email usado para enviar
  password       String   @db.Text // Encriptada
  isPredeterminada Boolean @default(false) @map("is_predeterminada")
  activa         Boolean  @default(true)
  creadaPor      String?  @map("creada_por") @db.VarChar(36)
  fechaCreacion  DateTime @default(now()) @map("fecha_creacion") @db.DateTime(3)

  // Relations
  creador   User?                @relation("SMTPCreator", fields: [creadaPor], references: [id], onDelete: SetNull)
  logs      NotificationLog[]
  scheduled ScheduledNotification[]

  @@index([isPredeterminada])
  @@index([activa])
  @@map("smtp_accounts")
}

// Plantillas de notificaciones
model NotificationTemplate {
  id             String   @id @default(uuid()) @db.VarChar(36)
  nombre         String   @db.VarChar(191)
  asunto         String   @db.Text // Puede contener variables: {nombre_cliente}
  contenidoHTML  String   @map("contenido_html") @db.Text
  variables      Json?    // Array de variables disponibles: ["cliente", "impuesto", "fecha"]
  tipo           String   @db.VarChar(50) // RECORDATORIO, INFORMATIVO, URGENTE
  activa         Boolean  @default(true)
  creadoPor      String?  @map("creado_por") @db.VarChar(36)
  fechaCreacion  DateTime @default(now()) @map("fecha_creacion") @db.DateTime(3)
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion") @db.DateTime(3)

  // Relations
  creador   User?                  @relation("TemplateCreator", fields: [creadoPor], references: [id], onDelete: SetNull)
  logs      NotificationLog[]
  scheduled ScheduledNotification[]

  @@index([tipo])
  @@index([activa])
  @@map("notification_templates")
}

// Historial de notificaciones enviadas
model NotificationLog {
  id              String   @id @default(uuid()) @db.VarChar(36)
  plantillaId     String?  @map("plantilla_id") @db.VarChar(36)
  smtpAccountId   String?  @map("smtp_account_id") @db.VarChar(36)
  destinatarios   Json     // Array de emails
  asunto          String   @db.Text
  contenido       String   @db.Text
  tipo            String   @db.VarChar(50) // EMAIL
  estado          String   @db.VarChar(50) // ENVIADO, FALLIDO, PENDIENTE
  fechaEnvio      DateTime @map("fecha_envio") @db.DateTime(3)
  enviadoPor      String?  @map("enviado_por") @db.VarChar(36)
  metadata        Json?    // Información adicional

  // Relations
  plantilla   NotificationTemplate? @relation(fields: [plantillaId], references: [id], onDelete: SetNull)
  smtpAccount SMTPAccount?          @relation(fields: [smtpAccountId], references: [id], onDelete: SetNull)
  enviador    User?                 @relation("NotificationSender", fields: [enviadoPor], references: [id], onDelete: SetNull)

  @@index([estado])
  @@index([fechaEnvio])
  @@index([tipo])
  @@map("notification_logs")
}

// Notificaciones programadas
model ScheduledNotification {
  id                    String   @id @default(uuid()) @db.VarChar(36)
  plantillaId           String   @map("plantilla_id") @db.VarChar(36)
  smtpAccountId         String?  @map("smtp_account_id") @db.VarChar(36)
  destinatariosSeleccionados Json @map("destinatarios_seleccionados") // Filtros o clientes específicos
  fechaProgramada       DateTime @map("fecha_programada") @db.DateTime(3)
  estado                String   @db.VarChar(50) @default("PENDIENTE") // PENDIENTE, ENVIADA, CANCELADA
  recurrencia           String   @db.VarChar(50) @default("NINGUNA") // NINGUNA, DIARIA, SEMANAL, MENSUAL
  creadoPor             String?  @map("creado_por") @db.VarChar(36)
  fechaCreacion         DateTime @default(now()) @map("fecha_creacion") @db.DateTime(3)

  // Relations
  plantilla   NotificationTemplate @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  smtpAccount SMTPAccount?         @relation(fields: [smtpAccountId], references: [id], onDelete: SetNull)
  creador     User?                @relation("ScheduledNotificationCreator", fields: [creadoPor], references: [id], onDelete: SetNull)

  @@index([estado])
  @@index([fechaProgramada])
  @@map("scheduled_notifications")
}

// ==================== SISTEMA: CONFIGURACIÓN Y ACTUALIZACIONES ====================

// Configuración del sistema
model SystemConfig {
  id                 String   @id @default(uuid()) @db.VarChar(36)
  key                String   @unique @db.VarChar(100) // Clave única de configuración
  value              String   @db.Text // Valor de la configuración
  description        String?  @db.Text // Descripción de qué hace esta config
  isEditable         Boolean  @default(true) @map("is_editable") // Si se puede editar desde la UI
  createdAt          DateTime @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.DateTime(3)

  @@map("system_config")
}

// Registro de backups del sistema
model SystemBackup {
  id                 String       @id @default(uuid()) @db.VarChar(36)
  version            String       @db.VarChar(50) // Versión del sistema al momento del backup
  dbFile             String       @map("db_file") @db.VarChar(500) // Ruta al archivo .sql
  filesFile          String       @map("files_file") @db.VarChar(500) // Ruta al archivo .zip
  dbSize             BigInt       @default(0) @map("db_size") // Tamaño del backup de BD en bytes
  filesSize          BigInt       @default(0) @map("files_size") // Tamaño del backup de archivos en bytes
  status             BackupStatus @default(CREATING)
  errorMessage       String?      @map("error_message") @db.Text
  createdBy          String?      @map("created_by") @db.VarChar(36)
  createdAt          DateTime     @default(now()) @map("created_at") @db.DateTime(3)
  completedAt        DateTime?    @map("completed_at") @db.DateTime(3)

  // Relations
  creator User? @relation("BackupCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("system_backups")
}

// Registro de actualizaciones del sistema
model SystemUpdate {
  id                 String       @id @default(uuid()) @db.VarChar(36)
  fromVersion        String       @map("from_version") @db.VarChar(50) // Versión inicial
  toVersion          String       @map("to_version") @db.VarChar(50) // Versión destino
  status             UpdateStatus @default(CHECKING)
  logs               Json?        // Logs del proceso de actualización
  backupId           String?      @map("backup_id") @db.VarChar(36) // ID del backup creado
  errorMessage       String?      @map("error_message") @db.Text
  initiatedBy        String?      @map("initiated_by") @db.VarChar(36)
  createdAt          DateTime     @default(now()) @map("created_at") @db.DateTime(3)
  completedAt        DateTime?    @map("completed_at") @db.DateTime(3)

  // Relations
  initiator User? @relation("UpdateInitiator", fields: [initiatedBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("system_updates")
}

// Configuración de almacenamiento externo (FTP/SMB/NAS)
model StorageConfig {
  id                String      @id @default(uuid()) @db.VarChar(36)
  type              StorageType @default(LOCAL)
  name              String      @db.VarChar(200) // Nombre descriptivo del storage
  host              String?     @db.VarChar(500) // Host/IP para FTP/SMB
  port              Int?        // Puerto para FTP/SMB
  username          String?     @db.VarChar(200) // Usuario para FTP/SMB
  encryptedPassword String?     @map("encrypted_password") @db.Text // Contraseña cifrada AES-256-GCM
  basePath          String      @default("/uploads") @map("base_path") @db.VarChar(1000) // Ruta base de almacenamiento
  isActive          Boolean     @default(false) @map("is_active") // Solo uno puede estar activo
  createdAt         DateTime    @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.DateTime(3)

  @@index([type])
  @@index([isActive])
  @@map("storage_configs")
}

// ==================== NUEVO SISTEMA DE GESTIÓN DE IMPUESTOS ====================

// Catálogo de impuestos (IVA, IRPF, etc.)
model Impuesto {
  id          String   @id @default(uuid()) @db.VarChar(36)
  nombre      String   @db.VarChar(100) // Ej: IVA, IRPF, Sociedades
  modelo      String   @db.VarChar(10)  // Ej: 303, 111, 200
  descripcion String?  @db.Text
  activo      Boolean  @default(true)   // Si el impuesto está activo
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.DateTime(3)

  // Relations
  obligaciones ObligacionFiscal[]

  @@unique([modelo])
  @@index([modelo])
  @@map("impuestos")
}

// Obligaciones fiscales de cada cliente (qué impuestos presenta y con qué periodicidad)
model ObligacionFiscal {
  id              String        @id @default(uuid()) @db.VarChar(36)
  clienteId       String        @map("cliente_id") @db.VarChar(36)
  impuestoId      String        @map("impuesto_id") @db.VarChar(36)
  periodicidad    Periodicidad  // MENSUAL, TRIMESTRAL, ANUAL
  diaVencimiento  Int?          @map("dia_vencimiento") // Día del mes para vencimiento (1-31)
  fechaInicio     DateTime      @map("fecha_inicio") @db.DateTime(3) // Desde cuándo aplica
  fechaFin        DateTime?     @map("fecha_fin") @db.DateTime(3)    // NULL = vigente
  observaciones   String?       @db.Text
  fechaAsignacion DateTime      @default(now()) @map("fecha_asignacion") @db.DateTime(3)
  activo          Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.DateTime(3)

  // Relations
  cliente       Client        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  impuesto      Impuesto      @relation(fields: [impuestoId], references: [id], onDelete: Cascade)
  declaraciones Declaracion[]

  @@index([clienteId])
  @@index([impuestoId])
  @@index([fechaFin]) // Para búsquedas de obligaciones vigentes
  @@index([activo])
  @@map("obligaciones_fiscales")
}

// Calendario oficial de la AEAT (períodos y fechas límite por modelo)
model CalendarioAEAT {
  id              String        @id @default(uuid()) @db.VarChar(36)
  modelo          String        @db.VarChar(10)  // Ej: 303, 111, 200
  periodicidad    Periodicidad  // MENSUAL, TRIMESTRAL, ANUAL
  periodoContable String        @map("periodo_contable") @db.VarChar(20) // Ej: 2025-Q2, 2025-04, 2025
  fechaInicio     DateTime      @map("fecha_inicio") @db.DateTime(3)     // Inicio del período
  fechaFin        DateTime      @map("fecha_fin") @db.DateTime(3)        // Fecha límite de presentación
  createdAt       DateTime      @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.DateTime(3)

  // Relations
  declaraciones Declaracion[]

  @@unique([modelo, periodicidad, periodoContable])
  @@index([periodoContable])
  @@index([modelo])
  @@index([fechaFin]) // Para búsquedas de vencimientos próximos
  @@map("calendario_aeat")
}

// Declaraciones individuales (seguimiento de presentación por período)
model Declaracion {
  id                 String            @id @default(uuid()) @db.VarChar(36)
  obligacionId       String            @map("obligacion_id") @db.VarChar(36)
  calendarioId       String            @map("calendario_id") @db.VarChar(36)
  estado             EstadoDeclaracion @default(PENDIENTE) // PENDIENTE, CALCULADO, PRESENTADO
  fechaPresentacion  DateTime?         @map("fecha_presentacion") @db.DateTime(3) // Solo si PRESENTADO
  archivoPdf         String?           @map("archivo_pdf") @db.VarChar(500)       // Ruta al justificante
  notas              String?           @db.Text
  createdAt          DateTime          @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt          DateTime          @updatedAt @map("updated_at") @db.DateTime(3)

  // Relations
  obligacion ObligacionFiscal @relation(fields: [obligacionId], references: [id], onDelete: Cascade)
  calendario CalendarioAEAT   @relation(fields: [calendarioId], references: [id], onDelete: Cascade)

  @@index([obligacionId])
  @@index([calendarioId])
  @@index([estado])
  @@index([fechaPresentacion])
  @@map("declaraciones")
}

// Notificaciones enviadas a clientes
model Notificacion {
  id          String            @id @default(uuid()) @db.VarChar(36)
  clienteId   String            @map("cliente_id") @db.VarChar(36)
  periodo     String            @db.VarChar(20) // Ej: 2025-Q2, 2025-04
  tipo        TipoNotificacion  // SOLICITUD_INFO, CONFIRMACION_PRESENTACION
  fechaEnvio  DateTime          @map("fecha_envio") @db.DateTime(3)
  enviada     Boolean           @default(true)
  asunto      String?           @db.VarChar(500)
  mensaje     String?           @db.Text
  createdAt   DateTime          @default(now()) @map("created_at") @db.DateTime(3)

  // Relations
  cliente Client @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([periodo])
  @@index([tipo])
  @@index([fechaEnvio])
  @@map("notificaciones")
}

// ======= Alias models para compatibilidad con código existente =======
// Muchas partes del código esperan modelos con nombres en inglés
// (taxModel, taxPeriod, clientTax, taxFile, clientTaxRequirement, fiscalPeriod, clientTaxFiling)
// pero el schema principal usa nombres en español. Estos modelos son "alias"
// que mappean a las mismas tablas en la base de datos para mantener compatibilidad
// sin modificar el resto de la aplicación.

model taxModel {
  id          String   @id @default(uuid()) @db.VarChar(36)
  nombre      String   @db.VarChar(191)
  descripcion String?  @db.Text

  // Relations
  periods taxPeriod[]  @relation("TaxModelPeriods")

  @@map("tax_models")
}

model taxPeriod {
  id                  String    @id @default(uuid()) @db.VarChar(36)
  modeloId            String    @map("modelo_id") @db.VarChar(36)
  anio                Int
  trimestre           Int?
  mes                 Int?
  inicioPresentacion  DateTime  @map("inicio_presentacion") @db.DateTime(3)
  finPresentacion     DateTime  @map("fin_presentacion") @db.DateTime(3)

  // Relations
  modelo taxModel @relation("TaxModelPeriods", fields: [modeloId], references: [id], onDelete: Cascade)
  clientTaxes clientTax[]

  @@map("tax_periods")
}

model clientTax {
  id               String   @id @default(uuid()) @db.VarChar(36)
  clientId         String   @map("client_id") @db.VarChar(36)
  taxPeriodId      String   @map("tax_period_id") @db.VarChar(36)
  estado           String   @db.VarChar(50)
  notas            String?  @db.Text
  displayText      String?  @map("display_text")
  colorTag         String?  @map("color_tag")
  fechaCreacion    DateTime @map("fecha_creacion") @db.DateTime(3)
  fechaActualizacion DateTime @map("fecha_actualizacion") @db.DateTime(3)

  // Relations
  client Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  period taxPeriod @relation(fields: [taxPeriodId], references: [id], onDelete: Cascade)
  files taxFile[]

  @@map("client_tax")
}

model taxFile {
  id            String   @id @default(uuid()) @db.VarChar(36)
  clientTaxId   String   @map("client_tax_id") @db.VarChar(36)
  nombreArchivo String   @map("nombre_archivo") @db.Text
  s3Url         String   @map("s3_url") @db.Text
  s3Key         String   @map("s3_key") @db.Text
  tipo          String?  @db.VarChar(50)
  tamanio       Int?
  fechaSubida   DateTime @map("fecha_subida") @db.DateTime(3)
  subidoPor     String?  @map("subido_por") @db.VarChar(36)

  // Relations
  clientTax clientTax @relation(fields: [clientTaxId], references: [id], onDelete: Cascade)

  @@map("tax_files")
}

model clientTaxRequirement {
  id           String  @id @default(uuid()) @db.VarChar(36)
  clientId     String  @map("client_id") @db.VarChar(36)
  impuesto     String  @db.VarChar(191)
  detalle      String? @db.Text
  taxModelCode String? @map("tax_model_code") @db.VarChar(50)
  required     Boolean @default(true)
  note         String? @map("note") @db.Text
  colorTag     String? @map("color_tag") @db.VarChar(50)

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_tax_requirements")
}

model fiscalPeriod {
  id      String   @id @default(uuid()) @db.VarChar(36)
  year    Int
  quarter Int
  label   String   @db.VarChar(50)
  startsAt DateTime @map("starts_at") @db.DateTime(3)
  endsAt   DateTime @map("ends_at") @db.DateTime(3)

  // Relations
  filings clientTaxFiling[]

  @@map("fiscal_periods")
}

model clientTaxFiling {
  id           String  @id @default(uuid()) @db.VarChar(36)
  clientId     String  @map("client_id") @db.VarChar(36)
  taxModelCode String  @map("tax_model_code") @db.VarChar(50)
  periodId     String  @map("period_id") @db.VarChar(36)
  status       String  @db.VarChar(50)
  notes        String? @db.Text
  presentedAt  DateTime? @map("presented_at") @db.DateTime(3)

  // Relations
  client Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  period fiscalPeriod? @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([clientId, taxModelCode, periodId], map: "clientId_taxModelCode_periodId")
  @@map("client_tax_filings")
}

// (clientTaxes añadido arriba en el modelo Client)
