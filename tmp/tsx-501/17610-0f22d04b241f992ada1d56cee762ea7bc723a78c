{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import cron from\"node-cron\";import nodemailer from\"nodemailer\";import{addDays,format}from\"date-fns\";import{es}from\"date-fns/locale\";let prisma;function initializeJobs(client){prisma=client}__name(initializeJobs,\"initializeJobs\");const transporter=nodemailer.createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||\"587\"),secure:process.env.SMTP_SECURE===\"true\",auth:process.env.SMTP_USER&&process.env.SMTP_PASS?{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}:void 0});let isMailConfigured=false;transporter.verify((error,success)=>{if(error){console.warn(\"\\u26A0\\uFE0F  SMTP no configurado - emails deshabilitados:\",error.message);isMailConfigured=false}else{console.log(\"\\u2705 SMTP configurado correctamente\");isMailConfigured=true}});async function sendEmail(to,subject,html){if(!isMailConfigured){console.log(`\\u{1F4E7} Email no enviado (SMTP no configurado): ${to} - ${subject}`);return}try{await transporter.sendMail({from:process.env.SMTP_USER,to,subject,html});console.log(`\\u2705 Email enviado: ${to} - ${subject}`)}catch(error){console.error(`\\u274C Error enviando email a ${to}:`,error)}}__name(sendEmail,\"sendEmail\");const taskRemindersJob=cron.createTask(\"0 9 * * *\",async()=>{console.log(\"\\u{1F514} Ejecutando job: recordatorios de tareas\");try{const tomorrow=addDays(new Date,1);const nextWeek=addDays(new Date,7);const upcomingTasks=await prisma.task.findMany({where:{estado:{notIn:[\"COMPLETADA\"]},fechaVencimiento:{gte:new Date,lte:nextWeek}},include:{cliente:true,asignado:true}});console.log(`\\u{1F4CB} Tareas pr\\xF3ximas a vencer: ${upcomingTasks.length}`);for(const task of upcomingTasks){if(!task.fechaVencimiento)continue;const diasRestantes=Math.ceil((new Date(task.fechaVencimiento).getTime()-new Date().getTime())/(1e3*60*60*24));if(diasRestantes<=0)continue;const urgencia=diasRestantes<=1?\"URGENTE\":diasRestantes<=3?\"Pr\\xF3ximo\":\"Recordatorio\";const color=diasRestantes<=1?\"#dc2626\":diasRestantes<=3?\"#f59e0b\":\"#3b82f6\";const html=`\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <div style=\"background: ${color}; color: white; padding: 20px; text-align: center;\">\n            <h2 style=\"margin: 0;\">${urgencia}: Tarea pr\\xF3xima a vencer</h2>\n          </div>\n          <div style=\"padding: 20px; background: #f9fafb;\">\n            <h3>${task.titulo}</h3>\n            <p><strong>Cliente:</strong> ${task.cliente?.razonSocial||\"Sin cliente\"}</p>\n            <p><strong>Descripci\\xF3n:</strong> ${task.descripcion||\"Sin descripci\\xF3n\"}</p>\n            <p><strong>Vence:</strong> ${format(new Date(task.fechaVencimiento),\"dd 'de' MMMM, yyyy\",{locale:es})}</p>\n            <p><strong>D\\xEDas restantes:</strong> ${diasRestantes}</p>\n            <p><strong>Prioridad:</strong> ${task.prioridad}</p>\n            <hr style=\"margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;\">\n            <p style=\"color: #6b7280; font-size: 14px;\">\n              Este es un recordatorio autom\\xE1tico del sistema Asesor\\xEDa La Llave.\n            </p>\n          </div>\n        </div>\n      `;if(task.asignado?.email){await sendEmail(task.asignado.email,`${urgencia}: ${task.titulo} - Vence en ${diasRestantes} d\\xEDa(s)`,html)}}}catch(error){console.error(\"\\u274C Error en job de recordatorios de tareas:\",error)}});const taxRemindersJob=cron.createTask(\"0 8 * * *\",async()=>{console.log(\"\\u{1F514} Ejecutando job: recordatorios fiscales\");try{const now=new Date;const nextMonth=addDays(now,30);const clientes=await prisma.client.findMany({include:{clientTaxes:{include:{period:{include:{modelo:true}}}}}});console.log(`\\u{1F4CA} Clientes con impuestos: ${clientes.length}`);for(const cliente of clientes){if(!cliente.clientTaxes||cliente.clientTaxes.length===0)continue;for(const clientTax of cliente.clientTaxes){const period=clientTax.period;if(!period)continue;const diasRestantes=Math.ceil((new Date(period.finPresentacion).getTime()-now.getTime())/(1e3*60*60*24));if([7,3,1].includes(diasRestantes)){const color=diasRestantes===1?\"#dc2626\":diasRestantes===3?\"#f59e0b\":\"#3b82f6\";const urgencia=diasRestantes===1?\"URGENTE\":\"Recordatorio\";const html=`\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n              <div style=\"background: ${color}; color: white; padding: 20px; text-align: center;\">\n                <h2 style=\"margin: 0;\">${urgencia}: Obligaci\\xF3n Fiscal Pr\\xF3xima</h2>\n              </div>\n              <div style=\"padding: 20px; background: #f9fafb;\">\n                <h3>${period.modelo.nombre} - ${period.anio}</h3>\n                <p><strong>Cliente:</strong> ${cliente.razonSocial}</p>\n                <p><strong>NIF/CIF:</strong> ${cliente.nifCif}</p>\n                <p><strong>Periodo:</strong> ${period.trimestre?`Trimestre ${period.trimestre}`:period.mes?`Mes ${period.mes}`:period.anio}</p>\n                <p><strong>Fecha l\\xEDmite:</strong> ${format(new Date(period.finPresentacion),\"dd 'de' MMMM, yyyy\",{locale:es})}</p>\n                <p><strong>D\\xEDas restantes:</strong> ${diasRestantes}</p>\n                <p><strong>Estado:</strong> ${clientTax.estado}</p>\n                <hr style=\"margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;\">\n                <p style=\"color: #6b7280; font-size: 14px;\">\n                  Este es un recordatorio autom\\xE1tico del sistema Asesor\\xEDa La Llave.\n                </p>\n              </div>\n            </div>\n          `;if(cliente.email){await sendEmail(cliente.email,`${urgencia}: ${period.modelo.nombre} - Vence en ${diasRestantes} d\\xEDa(s)`,html)}}}}}catch(error){console.error(\"\\u274C Error en job de recordatorios fiscales:\",error)}});const cleanupSessionsJob=cron.createTask(\"0 * * * *\",async()=>{console.log(\"\\u{1F9F9} Ejecutando job: limpieza de sesiones\");try{console.log(\"\\u2705 Sesiones limpias\")}catch(error){console.error(\"\\u274C Error en job de limpieza:\",error)}});const backupDatabaseJob=cron.createTask(\"0 3 * * *\",async()=>{console.log(\"\\u{1F4BE} Ejecutando job: backup de base de datos\");try{const{spawn}=require(\"child_process\");const path=require(\"path\");const backupScript=path.join(process.cwd(),\"scripts\",\"backup.sh\");const backup=spawn(\"bash\",[backupScript],{env:process.env,stdio:\"inherit\"});backup.on(\"close\",code=>{if(code===0){console.log(\"\\u2705 Backup completado exitosamente\")}else{console.error(`\\u274C Backup fall\\xF3 con c\\xF3digo: ${code}`)}})}catch(error){console.error(\"\\u274C Error en job de backup:\",error)}});function startAllJobs(){if(!prisma){throw new Error(\"\\u274C JOBS ERROR: Prisma client no inicializado.\\n   Debe llamar a initializeJobs(prisma) antes de startAllJobs().\\n   Ver server/index.ts para el orden correcto de inicializaci\\xF3n.\")}const isDev=process.env.NODE_ENV!==\"production\";const enableCronJobs=process.env.ENABLE_CRON_JOBS===\"true\";if(!isDev&&!enableCronJobs){console.warn(\"\\u26A0\\uFE0F  ADVERTENCIA: Cron jobs deshabilitados en este entorno.\\n   Los Autoscale Deployments no soportan procesos persistentes.\\n   Use Scheduled Deployments de Replit para tareas programadas.\\n   O configure ENABLE_CRON_JOBS=true en Reserved VM Deployments.\\n   Documentaci\\xF3n: https://docs.replit.com/hosting/deployments/scheduled-deployments\");return}console.log(\"\\u{1F680} Iniciando jobs programados...\");taskRemindersJob.start();console.log(\"  \\u2713 Recordatorios de tareas (09:00 diario)\");taxRemindersJob.start();console.log(\"  \\u2713 Recordatorios fiscales (08:00 diario)\");cleanupSessionsJob.start();console.log(\"  \\u2713 Limpieza de sesiones (cada hora)\");backupDatabaseJob.start();console.log(\"  \\u2713 Backup autom\\xE1tico (03:00 diario)\");console.log(\"\\u2705 Todos los jobs activos\")}__name(startAllJobs,\"startAllJobs\");function stopAllJobs(){if(!prisma){throw new Error(\"Jobs no inicializados: debe llamar initializeJobs(prisma) primero\")}taskRemindersJob.stop();taxRemindersJob.stop();cleanupSessionsJob.stop();backupDatabaseJob.stop();console.log(\"\\u{1F6D1} Todos los jobs detenidos\")}__name(stopAllJobs,\"stopAllJobs\");var jobs_default={initializeJobs,startAllJobs,stopAllJobs,taskRemindersJob,taxRemindersJob,cleanupSessionsJob,backupDatabaseJob};export{backupDatabaseJob,cleanupSessionsJob,jobs_default as default,initializeJobs,startAllJobs,stopAllJobs,taskRemindersJob,taxRemindersJob};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/jobs.ts"],"sourcesContent":[null]}}