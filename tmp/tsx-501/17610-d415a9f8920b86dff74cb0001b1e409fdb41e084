{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import nodemailer from\"nodemailer\";let smtpConfig=null;function configureSMTP(config){smtpConfig=config}__name(configureSMTP,\"configureSMTP\");function getSMTPConfig(){return smtpConfig}__name(getSMTPConfig,\"getSMTPConfig\");function createTransporter(){if(!smtpConfig){console.warn(\"SMTP not configured, skipping email\");return null}return nodemailer.createTransport({host:smtpConfig.host,port:smtpConfig.port,secure:smtpConfig.port===465,auth:{user:smtpConfig.user,pass:smtpConfig.pass}})}__name(createTransporter,\"createTransporter\");async function sendTaskReminderEmail(task,daysUntilDue){const transporter=createTransporter();if(!transporter||!task.assignedUser?.email||!smtpConfig)return;const subject=`Recordatorio: Tarea \"${task.titulo}\" vence en ${daysUntilDue} d\\xEDas`;const html=`\n    <div style=\"font-family: Inter, sans-serif; max-width: 600px; margin: 0 auto;\">\n      <h2 style=\"color: #1E3A8A;\">Recordatorio de Tarea</h2>\n      <p>Hola ${task.assignedUser.username},</p>\n      <p>Te recordamos que tienes una tarea pendiente que vence pronto:</p>\n      \n      <div style=\"background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n        <h3 style=\"margin-top: 0;\">${task.titulo}</h3>\n        ${task.descripcion?`<p>${task.descripcion}</p>`:\"\"}\n        <p><strong>Prioridad:</strong> ${task.prioridad}</p>\n        <p><strong>Vencimiento:</strong> ${task.fechaVencimiento?new Date(task.fechaVencimiento).toLocaleDateString(\"es-ES\"):\"No definido\"}</p>\n        <p><strong>D\\xEDas restantes:</strong> ${daysUntilDue}</p>\n      </div>\n      \n      <p>Por favor, aseg\\xFArate de completar esta tarea a tiempo.</p>\n      <p>Saludos,<br>Asesor\\xEDa La Llave</p>\n    </div>\n  `;try{await transporter.sendMail({from:smtpConfig.user,to:task.assignedUser.email,subject,html});console.log(`Email sent to ${task.assignedUser.email} for task ${task.id}`)}catch(error){console.error(\"Error sending task reminder email:\",error)}}__name(sendTaskReminderEmail,\"sendTaskReminderEmail\");async function sendTaxReminderEmail(clientTax,daysUntilDue){const transporter=createTransporter();if(!transporter||!clientTax.client?.email||!smtpConfig)return;const modelName=clientTax.taxPeriod?.taxModel?.nombre||\"Modelo fiscal\";const period=clientTax.taxPeriod?`${clientTax.taxPeriod.trimestre?`T${clientTax.taxPeriod.trimestre}`:clientTax.taxPeriod.mes?`Mes ${clientTax.taxPeriod.mes}`:\"\"} ${clientTax.taxPeriod.anio}`:\"Periodo no especificado\";const subject=`Recordatorio: ${modelName} vence en ${daysUntilDue} d\\xEDas`;const html=`\n    <div style=\"font-family: Inter, sans-serif; max-width: 600px; margin: 0 auto;\">\n      <h2 style=\"color: #1E3A8A;\">Recordatorio de Impuesto</h2>\n      <p>Estimado cliente ${clientTax.client.razonSocial},</p>\n      <p>Le recordamos que tiene un modelo fiscal pendiente que vence pronto:</p>\n      \n      <div style=\"background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n        <h3 style=\"margin-top: 0;\">${modelName}</h3>\n        <p><strong>Periodo:</strong> ${period}</p>\n        <p><strong>Estado:</strong> ${clientTax.estado}</p>\n        <p><strong>Fecha l\\xEDmite:</strong> ${clientTax.taxPeriod?.finPresentacion?new Date(clientTax.taxPeriod.finPresentacion).toLocaleDateString(\"es-ES\"):\"No definida\"}</p>\n        <p><strong>D\\xEDas restantes:</strong> ${daysUntilDue}</p>\n        ${clientTax.notas?`<p><strong>Notas:</strong> ${clientTax.notas}</p>`:\"\"}\n      </div>\n      \n      <p>Por favor, aseg\\xFArese de presentar este modelo antes de la fecha l\\xEDmite para evitar sanciones.</p>\n      <p>Atentamente,<br>Asesor\\xEDa La Llave</p>\n    </div>\n  `;try{await transporter.sendMail({from:smtpConfig.user,to:clientTax.client.email,subject,html});console.log(`Email sent to ${clientTax.client.email} for tax ${clientTax.id}`)}catch(error){console.error(\"Error sending tax reminder email:\",error)}}__name(sendTaxReminderEmail,\"sendTaxReminderEmail\");async function checkAndSendReminders(storage){const now=new Date;const tasks=await storage.getAllTasks();for(const task of tasks){if(task.fechaVencimiento&&task.estado!==\"COMPLETADA\"&&task.asignadoA){const dueDate=new Date(task.fechaVencimiento);const daysUntilDue=Math.ceil((dueDate.getTime()-now.getTime())/(1e3*60*60*24));if(daysUntilDue===3){const assignedUser=await storage.getUser(task.asignadoA);if(assignedUser){await sendTaskReminderEmail({...task,assignedUser},daysUntilDue)}}}}const clientTaxes=await storage.getAllClientTax();for(const clientTax of clientTaxes){if(clientTax.estado!==\"REALIZADO\"){const taxPeriod=await storage.getTaxPeriod(clientTax.taxPeriodId);if(taxPeriod?.finPresentacion){const dueDate=new Date(taxPeriod.finPresentacion);const daysUntilDue=Math.ceil((dueDate.getTime()-now.getTime())/(1e3*60*60*24));if(daysUntilDue===7){const client=await storage.getClient(clientTax.clientId);const taxModel=await storage.getTaxModel(taxPeriod.modeloId);if(client){await sendTaxReminderEmail({...clientTax,client,taxPeriod:{...taxPeriod,taxModel}},daysUntilDue)}}}}}}__name(checkAndSendReminders,\"checkAndSendReminders\");export{checkAndSendReminders,configureSMTP,getSMTPConfig,sendTaskReminderEmail,sendTaxReminderEmail};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/email.ts"],"sourcesContent":[null]}}