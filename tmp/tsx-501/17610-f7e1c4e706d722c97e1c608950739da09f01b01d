{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{PrismaClient}from\"@prisma/client\";import{LocalStorageProvider}from\"./storage-provider\";import{FTPStorageProvider}from\"./ftp-storage-provider\";import{SMBStorageProvider}from\"./smb-storage-provider\";import crypto from\"crypto\";import path from\"path\";const prisma=new PrismaClient;const ALGORITHM=\"aes-256-gcm\";function getEncryptionKey(){const envKey=process.env.STORAGE_ENCRYPTION_KEY;if(!envKey||envKey.length<32){throw new Error(\"STORAGE_ENCRYPTION_KEY no configurada o muy corta. Debe tener al menos 32 caracteres.\")}return envKey}__name(getEncryptionKey,\"getEncryptionKey\");function encryptPassword(password){const ENCRYPTION_KEY=getEncryptionKey();const iv=crypto.randomBytes(16);const cipher=crypto.createCipheriv(ALGORITHM,Buffer.from(ENCRYPTION_KEY.slice(0,32)),iv);let encrypted=cipher.update(password,\"utf8\",\"hex\");encrypted+=cipher.final(\"hex\");const authTag=cipher.getAuthTag();return`${iv.toString(\"hex\")}:${authTag.toString(\"hex\")}:${encrypted}`}__name(encryptPassword,\"encryptPassword\");function decryptPassword(encryptedData){try{const ENCRYPTION_KEY=getEncryptionKey();const parts=encryptedData.split(\":\");if(parts.length!==3){throw new Error(\"Formato de datos cifrados inv\\xE1lido\")}const iv=Buffer.from(parts[0],\"hex\");const authTag=Buffer.from(parts[1],\"hex\");const encrypted=parts[2];const decipher=crypto.createDecipheriv(ALGORITHM,Buffer.from(ENCRYPTION_KEY.slice(0,32)),iv);decipher.setAuthTag(authTag);let decrypted=decipher.update(encrypted,\"hex\",\"utf8\");decrypted+=decipher.final(\"utf8\");return decrypted}catch(error){throw new Error(\"Error al descifrar contrase\\xF1a\")}}__name(decryptPassword,\"decryptPassword\");class StorageFactory{static{__name(this,\"StorageFactory\")}static{this.instance=null}static{this.currentConfigId=null}static async getActiveProvider(){const activeConfig=await prisma.storageConfig.findFirst({where:{isActive:true}});if(!activeConfig||this.currentConfigId!==activeConfig.id||!this.instance){this.instance=await this.createProvider(activeConfig);this.currentConfigId=activeConfig?.id||null}return this.instance}static async getProviderById(configId){const config=await prisma.storageConfig.findUnique({where:{id:configId}});if(!config){throw new Error(`Configuraci\\xF3n de storage no encontrada: ${configId}`)}return this.createProvider(config)}static async createProvider(config){if(!config||config.type===\"LOCAL\"){const basePath=config?.basePath?path.join(process.cwd(),config.basePath):void 0;return new LocalStorageProvider(basePath)}if(config.type===\"FTP\"){if(!config.host||!config.port||!config.username||!config.encryptedPassword){throw new Error(\"Configuraci\\xF3n FTP incompleta\")}const ftpConfig={host:config.host,port:config.port,user:config.username,password:decryptPassword(config.encryptedPassword),basePath:config.basePath||\"/uploads\",secure:false};return new FTPStorageProvider(ftpConfig)}if(config.type===\"SMB\"){if(!config.host||!config.username||!config.encryptedPassword){throw new Error(\"Configuraci\\xF3n SMB incompleta\")}const pathParts=config.basePath.split(\"/\").filter(p=>p);const share=pathParts[0]||\"uploads\";const basePath=\"/\"+pathParts.slice(1).join(\"/\");const smbConfig={host:config.host,port:config.port||445,domain:\"\",username:config.username,password:decryptPassword(config.encryptedPassword),basePath:basePath||\"/\",share};return new SMBStorageProvider(smbConfig)}return new LocalStorageProvider(\"/uploads\")}static async testConfiguration(configId){const config=await prisma.storageConfig.findUnique({where:{id:configId}});if(!config){throw new Error(\"Configuraci\\xF3n no encontrada\")}const provider=await this.createProvider(config);if(\"testConnection\"in provider&&typeof provider.testConnection===\"function\"){return await provider.testConnection()}return true}static async testConfigurationData(config){try{const provider=await this.createProvider(config);if(\"testConnection\"in provider&&typeof provider.testConnection===\"function\"){const success=await provider.testConnection();if(success){return{success:true,message:\"Conexi\\xF3n exitosa\"}}else{return{success:false,message:\"Conexi\\xF3n fallida\"}}}return{success:true,message:\"Provider creado correctamente\"}}catch(error){return{success:false,message:error.message||\"Error al probar configuraci\\xF3n\"}}}static async clearInstance(){if(this.instance&&\"disconnect\"in this.instance){await this.instance.disconnect?.()}this.instance=null;this.currentConfigId=null}static async createProviderForConfig(configId){const config=await prisma.storageConfig.findUnique({where:{id:configId}});if(!config){throw new Error(\"Configuraci\\xF3n no encontrada\")}return await this.createProvider(config)}}export{StorageFactory,decryptPassword,encryptPassword};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/services/storage-factory.ts"],"sourcesContent":[null]}}