{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{PrismaClient}from\"@prisma/client\";import{exec}from\"child_process\";import{promisify}from\"util\";import{createSystemBackup,restoreFromBackup}from\"./backup-service.js\";import{getCurrentVersion,checkForUpdates,performHealthCheck}from\"./version-service.js\";import{emitSystemLog}from\"../websocket.js\";const execAsync=promisify(exec);const prisma=new PrismaClient;async function performSystemUpdate(userId,onProgress){const logs=[];let updateRecord=null;let backupId=null;const log=__name((step,message,level=\"info\")=>{const progress={step,message,timestamp:new Date};logs.push(progress);console.log(`[${step}] ${message}`);emitSystemLog({type:\"update\",level,message,details:step});if(onProgress){onProgress(progress)}},\"log\");try{const currentVersion=await getCurrentVersion();log(\"VERSION_CHECK\",`Versi\\xF3n actual: ${currentVersion}`);const repoUrlConfig=await prisma.systemConfig.findUnique({where:{key:\"github_repo_url\"}});if(!repoUrlConfig?.value){throw new Error(\"URL del repositorio de GitHub no configurada\")}const repoUrl=repoUrlConfig.value;let owner=null;let repo=null;if(/^[a-zA-Z0-9_-]+\\/[a-zA-Z0-9_.-]+$/.test(repoUrl)){[owner,repo]=repoUrl.split(\"/\")}else{try{const candidate=repoUrl.startsWith(\"http://\")||repoUrl.startsWith(\"https://\")?repoUrl:`https://${repoUrl}`;const parsed=new URL(candidate);const hostname=parsed.hostname.toLowerCase();if(!(hostname===\"github.com\"||hostname.endsWith(\".github.com\"))){throw new Error(\"URL de GitHub no v\\xE1lida\")}if(parsed.username||parsed.password){throw new Error(\"URL de GitHub no v\\xE1lida\")}const parts=parsed.pathname.split(\"/\").filter(Boolean);if(parts.length<2)throw new Error(\"URL de GitHub no v\\xE1lida\");owner=parts[0];repo=parts[1].replace(/\\.git$/,\"\")}catch(e){throw new Error(\"URL de GitHub no v\\xE1lida\")}}if(!owner||!repo){throw new Error(\"URL de GitHub no v\\xE1lida\")}log(\"UPDATE_CHECK\",\"Verificando actualizaciones disponibles...\");const versionInfo=await checkForUpdates(owner,repo.replace(\".git\",\"\"));if(!versionInfo.updateAvailable){log(\"NO_UPDATE\",\"No hay actualizaciones disponibles\");return{success:true,fromVersion:currentVersion,toVersion:currentVersion,logs}}log(\"UPDATE_AVAILABLE\",`Nueva versi\\xF3n disponible: ${versionInfo.latest}`);updateRecord=await prisma.systemUpdate.create({data:{fromVersion:currentVersion,toVersion:versionInfo.latest||\"unknown\",status:\"CHECKING\",initiatedBy:userId,logs:JSON.stringify(logs)}});log(\"BACKUP_START\",\"Creando backup de seguridad antes de actualizar...\");await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"BACKING_UP\",logs:JSON.stringify(logs)}});const backup=await createSystemBackup(userId);backupId=backup.id;await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{backupId:backup.id}});log(\"BACKUP_COMPLETE\",`Backup creado exitosamente: ${backup.id}`,\"success\");await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"DOWNLOADING\",logs:JSON.stringify(logs)}});log(\"GIT_PULL\",\"Descargando cambios desde GitHub...\");const branchConfig=await prisma.systemConfig.findUnique({where:{key:\"github_branch\"}});const branch=branchConfig?.value||\"main\";try{const{stdout:pullOutput}=await execAsync(`git pull origin ${branch}`);log(\"GIT_PULL_SUCCESS\",`C\\xF3digo descargado exitosamente desde rama '${branch}'`,\"success\");const newVersion=await getCurrentVersion();if(newVersion!==currentVersion){log(\"VERSION_CHANGED\",`\\u2728 Versi\\xF3n actualizada: ${currentVersion} \\u2192 ${newVersion}`,\"success\")}}catch(error){log(\"GIT_PULL_ERROR\",`Error en git pull: ${error.message}`,\"error\");throw new Error(`Error al descargar cambios: ${error.message}`)}await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"INSTALLING\",logs:JSON.stringify(logs)}});log(\"NPM_INSTALL\",\"Instalando dependencias...\");try{const{stdout:installOutput}=await execAsync(\"npm install\");log(\"NPM_INSTALL_SUCCESS\",\"Dependencias instaladas correctamente\",\"success\")}catch(error){log(\"NPM_INSTALL_ERROR\",`Error en npm install: ${error.message}`,\"error\");throw new Error(`Error al instalar dependencias: ${error.message}`)}log(\"DB_MIGRATE\",\"Aplicando migraciones de base de datos...\");try{await execAsync(\"npx prisma db push\");log(\"DB_MIGRATE_SUCCESS\",\"Migraciones aplicadas correctamente\",\"success\")}catch(error){log(\"DB_MIGRATE_WARNING\",`Advertencia en migraciones: ${error.message}`,\"warning\")}log(\"BUILD\",\"Compilando aplicaci\\xF3n para producci\\xF3n...\");try{await execAsync(\"npm run build\");log(\"BUILD_SUCCESS\",\"Aplicaci\\xF3n compilada exitosamente\",\"success\")}catch(error){log(\"BUILD_ERROR\",`Error en compilaci\\xF3n: ${error.message}`,\"error\");throw new Error(`Error al compilar aplicaci\\xF3n: ${error.message}`)}log(\"HEALTH_CHECK\",\"Verificando estado del sistema...\",\"info\");try{const healthResult=await performHealthCheck();if(healthResult.success){log(\"HEALTH_CHECK_SUCCESS\",\"Todas las verificaciones pasaron correctamente\",\"success\")}else{const failedChecks=healthResult.checks.filter(c=>c.status===\"fail\").map(c=>c.name).join(\", \");log(\"HEALTH_CHECK_WARNING\",`Algunas verificaciones fallaron: ${failedChecks}`,\"warning\")}for(const check of healthResult.checks){const level=check.status===\"pass\"?\"success\":\"warning\";log(`HEALTH_${check.name.toUpperCase()}`,`${check.name}: ${check.message}`,level)}}catch(error){log(\"HEALTH_CHECK_ERROR\",`Error en health check: ${error.message}`,\"warning\")}await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"COMPLETED\",completedAt:new Date,logs:JSON.stringify(logs)}});log(\"UPDATE_COMPLETE\",`\\u2705 Actualizaci\\xF3n completada: ${currentVersion} \\u2192 ${versionInfo.latest}`,\"success\");log(\"RESTART_REQUIRED\",\"\\u26A0\\uFE0F  Reinicie el servidor para aplicar los cambios\",\"warning\");return{success:true,fromVersion:currentVersion,toVersion:versionInfo.latest||\"unknown\",backupId:backupId||void 0,logs}}catch(error){log(\"ERROR\",`Error durante la actualizaci\\xF3n: ${error.message}`,\"error\");if(backupId){log(\"ROLLBACK_START\",\"Iniciando rollback autom\\xE1tico...\");try{await restoreFromBackup(backupId,userId);log(\"ROLLBACK_SUCCESS\",\"Rollback completado exitosamente\",\"success\");if(updateRecord){await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"ROLLED_BACK\",errorMessage:error.message,completedAt:new Date,logs:JSON.stringify(logs)}})}}catch(rollbackError){log(\"ROLLBACK_ERROR\",`Error en rollback: ${rollbackError.message}`,\"error\");if(updateRecord){await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"FAILED\",errorMessage:`Update failed: ${error.message}. Rollback also failed: ${rollbackError.message}`,completedAt:new Date,logs:JSON.stringify(logs)}})}}}else{if(updateRecord){await prisma.systemUpdate.update({where:{id:updateRecord.id},data:{status:\"FAILED\",errorMessage:error.message,completedAt:new Date,logs:JSON.stringify(logs)}})}}return{success:false,fromVersion:await getCurrentVersion(),toVersion:\"unknown\",backupId:backupId||void 0,logs,error:error.message}}}__name(performSystemUpdate,\"performSystemUpdate\");async function verifyGitSetup(){try{await execAsync(\"git --version\");try{const{stdout}=await execAsync(\"git remote -v\");if(stdout.includes(\"origin\")){return{installed:true,configured:true,message:\"Git est\\xE1 instalado y configurado correctamente\"}}else{return{installed:true,configured:false,message:\"Git est\\xE1 instalado pero no hay un repositorio remoto configurado\"}}}catch{return{installed:true,configured:false,message:\"Git est\\xE1 instalado pero este no es un repositorio Git\"}}}catch{return{installed:false,configured:false,message:\"Git no est\\xE1 instalado en el sistema\"}}}__name(verifyGitSetup,\"verifyGitSetup\");async function getUpdateHistory(limit=10){return await prisma.systemUpdate.findMany({take:limit,orderBy:{createdAt:\"desc\"},include:{initiator:{select:{id:true,username:true,email:true}}}})}__name(getUpdateHistory,\"getUpdateHistory\");export{getUpdateHistory,performSystemUpdate,verifyGitSetup};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/services/update-service.ts"],"sourcesContent":[null]}}