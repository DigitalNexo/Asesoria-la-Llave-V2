{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import SMB2 from\"@marsaud/smb2\";import path from\"path\";class SMBStorageProvider{constructor(config){this.client=null;this.config={...config,port:config.port||445,basePath:config.basePath||\"/uploads\",domain:config.domain||\"\"};this.initializeClient()}static{__name(this,\"SMBStorageProvider\")}initializeClient(){this.client=new SMB2({share:`\\\\\\\\${this.config.host}\\\\${this.config.share}`,domain:this.config.domain||\"\",username:this.config.username,password:this.config.password,port:this.config.port})}getSMBPath(relativePath){const combined=path.posix.join(this.config.basePath,relativePath);return combined.replace(/\\//g,\"\\\\\")}async upload(file,relativePath){const smbPath=this.getSMBPath(relativePath);const dir=path.dirname(smbPath);return new Promise((resolve,reject)=>{this.client.mkdir(dir,err=>{if(err&&err.code!==\"STATUS_OBJECT_NAME_COLLISION\"){}if(Buffer.isBuffer(file)){this.client.writeFile(smbPath,file,writeErr=>{if(writeErr){reject(new Error(`Error al escribir archivo SMB: ${writeErr.message}`))}else{resolve(relativePath)}})}else{const writeStream=this.client.createWriteStream(smbPath);writeStream.on(\"error\",streamErr=>{reject(new Error(`Error al escribir stream SMB: ${streamErr.message}`))});writeStream.on(\"finish\",()=>{resolve(relativePath)});file.pipe(writeStream)}})})}async download(relativePath){const smbPath=this.getSMBPath(relativePath);return new Promise((resolve,reject)=>{this.client.readFile(smbPath,(err,data)=>{if(err){reject(new Error(`Error al leer archivo SMB: ${err.message}`))}else{resolve(data)}})})}async delete(relativePath){const smbPath=this.getSMBPath(relativePath);return new Promise((resolve,reject)=>{this.client.unlink(smbPath,err=>{if(err){reject(new Error(`Error al eliminar archivo SMB: ${err.message}`))}else{resolve()}})})}async list(relativePath=\"\",recursive=false){const smbPath=this.getSMBPath(relativePath);const files=[];try{if(recursive){await this.listRecursive(smbPath,relativePath,files)}else{const items=await this.readdir(smbPath);for(const item of items){if(item.type===\"file\"){const filePath=path.posix.join(relativePath,item.name);files.push(filePath)}}}return files}catch(error){return[]}}async readdir(smbPath){return new Promise((resolve,reject)=>{this.client.readdir(smbPath,(err,files)=>{if(err){reject(err)}else{const items=files.map(file=>({name:file.name,type:file.type===\"directory\"?\"directory\":\"file\"}));resolve(items)}})})}async listRecursive(smbPath,relativePath,files){const items=await this.readdir(smbPath);for(const item of items){const itemRelativePath=path.posix.join(relativePath,item.name);const itemSMBPath=path.join(smbPath,item.name);if(item.type===\"file\"){files.push(itemRelativePath)}else if(item.type===\"directory\"){await this.listRecursive(itemSMBPath,itemRelativePath,files)}}}async exists(relativePath){const smbPath=this.getSMBPath(relativePath);return new Promise(resolve=>{this.client.exists(smbPath,(err,exists)=>{if(err){resolve(false)}else{resolve(exists)}})})}getPublicUrl(relativePath){return`/uploads/${relativePath}`}async disconnect(){return new Promise(resolve=>{if(this.client){this.client.disconnect();this.client=null}resolve()})}async testConnection(){try{const basePath=this.config.basePath.replace(/\\//g,\"\\\\\");await this.readdir(basePath);return true}catch(error){return false}}}export{SMBStorageProvider};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/services/smb-storage-provider.ts"],"sourcesContent":[null]}}