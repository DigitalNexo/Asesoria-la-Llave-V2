{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{StorageFactory}from\"../services/storage-factory\";import fs from\"fs/promises\";import path from\"path\";async function uploadToStorage(req,res,next){try{if(!req.file&&!req.files){return next()}const provider=await StorageFactory.getActiveProvider();if(req.file){await processFile(req.file,provider)}if(req.files&&Array.isArray(req.files)){for(const file of req.files){await processFile(file,provider)}}if(req.files&&!Array.isArray(req.files)){for(const fieldname in req.files){const files=req.files[fieldname];for(const file of files){await processFile(file,provider)}}}next()}catch(error){console.error(\"Error al subir archivo al storage:\",error);next(error)}}__name(uploadToStorage,\"uploadToStorage\");async function processFile(file,provider){const uploadsDir=path.join(process.cwd(),\"uploads\");const relativePath=path.relative(uploadsDir,file.path);const isLocal=provider.constructor.name===\"LocalStorageProvider\";if(isLocal){file.path=relativePath;file.destination=path.dirname(relativePath);return}const tempFilePath=file.path;const readStream=(await import(\"fs\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s})).createReadStream(tempFilePath);try{await provider.upload(readStream,relativePath);file.path=relativePath;file.destination=path.dirname(relativePath);await fs.unlink(tempFilePath)}catch(error){readStream.destroy();throw error}}__name(processFile,\"processFile\");async function downloadFromStorage(relativePath){const provider=await StorageFactory.getActiveProvider();return await provider.download(relativePath)}__name(downloadFromStorage,\"downloadFromStorage\");function serveFromStorage(){return async(req,res,next)=>{try{const relativePath=req.path.replace(\"/uploads/\",\"\");const provider=await StorageFactory.getActiveProvider();const exists=await provider.exists(relativePath);if(!exists){return res.status(404).json({error:\"Archivo no encontrado\"})}const fileBuffer=await provider.download(relativePath);const ext=path.extname(relativePath).toLowerCase();const mimeTypes={\".pdf\":\"application/pdf\",\".doc\":\"application/msword\",\".docx\":\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\".xls\":\"application/vnd.ms-excel\",\".xlsx\":\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\".jpg\":\"image/jpeg\",\".jpeg\":\"image/jpeg\",\".png\":\"image/png\",\".gif\":\"image/gif\",\".webp\":\"image/webp\",\".zip\":\"application/zip\"};const contentType=mimeTypes[ext]||\"application/octet-stream\";res.setHeader(\"Content-Type\",contentType);res.setHeader(\"Content-Length\",fileBuffer.length);res.send(fileBuffer)}catch(error){console.error(\"Error al servir archivo desde storage:\",error);next(error)}}}__name(serveFromStorage,\"serveFromStorage\");export{downloadFromStorage,serveFromStorage,uploadToStorage};\n","warnings":[],"map":{"version":3,"mappings":"kHACA,OAAS,mBAAsB,8BAC/B,OAAO,OAAQ,cACf,OAAO,SAAU,OAGjB,eAAsB,gBAAgB,IAAc,IAAe,KAAoB,CACrF,GAAI,CAEF,GAAI,CAAC,IAAI,MAAQ,CAAC,IAAI,MAAO,CAC3B,OAAO,KAAK,CACd,CAEA,MAAM,SAAW,MAAM,eAAe,kBAAkB,EAGxD,GAAI,IAAI,KAAM,CACZ,MAAM,YAAY,IAAI,KAAM,QAAQ,CACtC,CAGA,GAAI,IAAI,OAAS,MAAM,QAAQ,IAAI,KAAK,EAAG,CACzC,UAAW,QAAQ,IAAI,MAAO,CAC5B,MAAM,YAAY,KAAM,QAAQ,CAClC,CACF,CAGA,GAAI,IAAI,OAAS,CAAC,MAAM,QAAQ,IAAI,KAAK,EAAG,CAC1C,UAAW,aAAa,IAAI,MAAO,CACjC,MAAM,MAAQ,IAAI,MAAM,SAAS,EACjC,UAAW,QAAQ,MAAO,CACxB,MAAM,YAAY,KAAM,QAAQ,CAClC,CACF,CACF,CAEA,KAAK,CACP,OAAS,MAAO,CACd,QAAQ,MAAM,qCAAsC,KAAK,EACzD,KAAK,KAAK,CACZ,CACF,CApCsB,0CAsCtB,eAAe,YAAY,KAA2B,SAAe,CAGnE,MAAM,WAAa,KAAK,KAAK,QAAQ,IAAI,EAAG,SAAS,EACrD,MAAM,aAAe,KAAK,SAAS,WAAY,KAAK,IAAI,EAGxD,MAAM,QAAU,SAAS,YAAY,OAAS,uBAC9C,GAAI,QAAS,CACX,KAAK,KAAO,aACZ,KAAK,YAAc,KAAK,QAAQ,YAAY,EAC5C,MACF,CAGA,MAAM,aAAe,KAAK,KAC1B,MAAM,YAAc,KAAM,QAAO,IAAI,+FAAG,iBAAiB,YAAY,EAErE,GAAI,CAEF,MAAM,SAAS,OAAO,WAAY,YAAY,EAG9C,KAAK,KAAO,aACZ,KAAK,YAAc,KAAK,QAAQ,YAAY,EAG5C,MAAM,GAAG,OAAO,YAAY,CAC9B,OAAS,MAAO,CAEd,WAAW,QAAQ,EACnB,MAAM,KACR,CACF,CAjCe,kCAoCf,eAAsB,oBAAoB,aAAuC,CAC/E,MAAM,SAAW,MAAM,eAAe,kBAAkB,EACxD,OAAO,MAAM,SAAS,SAAS,YAAY,CAC7C,CAHsB,kDAMf,SAAS,kBAAmB,CACjC,MAAO,OAAO,IAAc,IAAe,OAAuB,CAChE,GAAI,CAEF,MAAM,aAAe,IAAI,KAAK,QAAQ,YAAa,EAAE,EAErD,MAAM,SAAW,MAAM,eAAe,kBAAkB,EAGxD,MAAM,OAAS,MAAM,SAAS,OAAO,YAAY,EACjD,GAAI,CAAC,OAAQ,CACX,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,uBAAwB,CAAC,CAChE,CAGA,MAAM,WAAa,MAAM,SAAS,SAAS,YAAY,EAGvD,MAAM,IAAM,KAAK,QAAQ,YAAY,EAAE,YAAY,EACnD,MAAM,UAAuC,CAC3C,OAAQ,kBACR,OAAQ,qBACR,QAAS,0EACT,OAAQ,2BACR,QAAS,oEACT,OAAQ,aACR,QAAS,aACT,OAAQ,YACR,OAAQ,YACR,QAAS,aACT,OAAQ,iBACV,EAEA,MAAM,YAAc,UAAU,GAAG,GAAK,2BAGtC,IAAI,UAAU,eAAgB,WAAW,EACzC,IAAI,UAAU,iBAAkB,WAAW,MAAM,EACjD,IAAI,KAAK,UAAU,CACrB,OAAS,MAAO,CACd,QAAQ,MAAM,yCAA0C,KAAK,EAC7D,KAAK,KAAK,CACZ,CACF,CACF,CA5CgB","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/middleware/storage-upload.ts"],"sourcesContent":[null]}}