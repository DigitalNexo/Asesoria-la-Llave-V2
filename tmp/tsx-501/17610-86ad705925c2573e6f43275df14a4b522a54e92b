{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{Client as FTPClient}from\"basic-ftp\";import{Readable}from\"stream\";import path from\"path\";class FTPStorageProvider{constructor(config){this.client=null;this.isConnected=false;this.connectionPromise=null;this.config={...config,basePath:config.basePath||\"/uploads\",secure:config.secure||false}}static{__name(this,\"FTPStorageProvider\")}async ensureConnection(){if(this.isConnected&&this.client){return}if(this.connectionPromise){return this.connectionPromise}this.connectionPromise=(async()=>{try{this.client=new FTPClient;this.client.ftp.verbose=false;await this.client.access({host:this.config.host,port:this.config.port,user:this.config.user,password:this.config.password,secure:this.config.secure});this.isConnected=true}catch(error){this.client=null;this.isConnected=false;throw new Error(`Error al conectar con FTP: ${error instanceof Error?error.message:\"Error desconocido\"}`)}finally{this.connectionPromise=null}})();return this.connectionPromise}async upload(file,relativePath){await this.ensureConnection();if(!this.client)throw new Error(\"Cliente FTP no conectado\");const fullPath=path.posix.join(this.config.basePath,relativePath);const dir=path.posix.dirname(fullPath);await this.client.ensureDir(dir);if(Buffer.isBuffer(file)){try{const stream=Readable.from(file);await this.client.uploadFrom(stream,fullPath)}catch(error){this.isConnected=false;await this.ensureConnection();const stream=Readable.from(file);await this.client.uploadFrom(stream,fullPath)}}else{await this.client.uploadFrom(file,fullPath)}return relativePath}async download(relativePath){await this.ensureConnection();if(!this.client)throw new Error(\"Cliente FTP no conectado\");const fullPath=path.posix.join(this.config.basePath,relativePath);const chunks=[];try{const writableStream=new(require(\"stream\")).Writable({write(chunk,encoding,callback){chunks.push(chunk);callback()}});await this.client.downloadTo(writableStream,fullPath);return Buffer.concat(chunks)}catch(error){this.isConnected=false;await this.ensureConnection();const writableStream=new(require(\"stream\")).Writable({write(chunk,encoding,callback){chunks.push(chunk);callback()}});await this.client.downloadTo(writableStream,fullPath);return Buffer.concat(chunks)}}async delete(relativePath){await this.ensureConnection();if(!this.client)throw new Error(\"Cliente FTP no conectado\");const fullPath=path.posix.join(this.config.basePath,relativePath);try{await this.client.remove(fullPath)}catch(error){this.isConnected=false;await this.ensureConnection();await this.client.remove(fullPath)}}async list(relativePath=\"\",recursive=false){await this.ensureConnection();if(!this.client)throw new Error(\"Cliente FTP no conectado\");const fullPath=path.posix.join(this.config.basePath,relativePath);const files=[];try{if(recursive){await this.listRecursive(fullPath,relativePath,files)}else{const items=await this.client.list(fullPath);for(const item of items){if(item.type===1){const filePath=path.posix.join(relativePath,item.name);files.push(filePath)}}}return files}catch(error){if(error.code===550){return[]}this.isConnected=false;await this.ensureConnection();return this.list(relativePath,recursive)}}async listRecursive(fullPath,relativePath,files){if(!this.client)return;const items=await this.client.list(fullPath);for(const item of items){const itemRelativePath=path.posix.join(relativePath,item.name);const itemFullPath=path.posix.join(fullPath,item.name);if(item.type===1){files.push(itemRelativePath)}else if(item.type===2){await this.listRecursive(itemFullPath,itemRelativePath,files)}}}async exists(relativePath){await this.ensureConnection();if(!this.client)throw new Error(\"Cliente FTP no conectado\");const fullPath=path.posix.join(this.config.basePath,relativePath);const dir=path.posix.dirname(fullPath);const filename=path.posix.basename(fullPath);try{const items=await this.client.list(dir);return items.some(item=>item.name===filename)}catch(error){if(error.code===550){return false}this.isConnected=false;await this.ensureConnection();return this.exists(relativePath)}}getPublicUrl(relativePath){return`/uploads/${relativePath}`}async disconnect(){if(this.client){this.client.close();this.client=null;this.isConnected=false}}async testConnection(){try{await this.ensureConnection();return this.isConnected}catch(error){return false}}}export{FTPStorageProvider};\n","warnings":[{"id":"unsupported-require-call","location":{"column":34,"file":"/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/services/ftp-storage-provider.ts","length":7,"line":119,"lineText":"      const writableStream = new (require('stream').Writable)({","namespace":"","suggestion":""},"notes":[],"pluginName":"","text":"Converting \"require\" to \"esm\" is currently not supported"}],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/usuario/Documents/Repositorios/Asesoria-La-Llave/server/services/ftp-storage-provider.ts"],"sourcesContent":[null]}}