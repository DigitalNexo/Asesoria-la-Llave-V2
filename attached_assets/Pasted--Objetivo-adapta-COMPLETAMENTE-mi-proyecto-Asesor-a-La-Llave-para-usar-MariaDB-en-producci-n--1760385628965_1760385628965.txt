
Objetivo: adapta COMPLETAMENTE mi proyecto “Asesoría La Llave” para usar **MariaDB** en producción y desarrollo (no Postgres). 
Quiero que pueda “enchufar” mi MariaDB propia (VPS/host externo) y que el proyecto traiga:
- Migraciones + esquema SQL completos para crear TODAS las tablas en MariaDB.
- Scripts de seed.
- Variables .env para MariaDB.
- Docker Compose con servicio mariadb opcional.
- Backups con mysqldump.
- Todo lo que ya tengo funcionando, pero apuntando a MariaDB.

### 0) ORM y capas de datos
- Sustituye el uso de Postgres/Drizzle por **Prisma** con provider `mysql` (compatible MariaDB) en `/prisma/schema.prisma`.
- Crea modelos Prisma para TODOS los módulos: users, roles, clients, tax_models, tax_periods, client_tax, tax_files, tasks (con visibilidad GENERAL|PERSONAL), manuals, activity_logs, smtp_config, job_runs (para cron), y cualquier tabla pivote (p.ej. client_user).
- Añade índices y claves foráneas coherentes.
- Genera migraciones Prisma en `/prisma/migrations`.
- Genera también un **dump SQL completo** de creación de tablas para MariaDB en `/database/schema_mariadb.sql` (charset `utf8mb4`, collation `utf8mb4_unicode_ci`), con todos los índices y FKs.
- Proporciona **scripts npm**:
  - `npm run db:generate` (prisma generate)
  - `npm run db:migrate` (prisma migrate deploy/dev según entorno)
  - `npm run db:seed` (semillas iniciales con contraseñas bcrypt)
  - `npm run db:sql` (export del SQL a `/database/schema_mariadb.sql`)

### 1) Variables de entorno (MariaDB)
- En `.env.example` define:
  NODE_ENV=development
  PORT=5000
  FRONTEND_URL=http://localhost:3000
  JWT_SECRET=CAMBIA_ESTE_VALOR
  DATABASE_URL="mysql://USER:PASS@HOST:3306/asesoria_llave?socket_timeout=60&connect_timeout=60"
  SMTP_HOST=
  SMTP_PORT=587
  SMTP_USER=
  SMTP_PASS=
  S3_ENDPOINT=
  S3_BUCKET=
  S3_ACCESS_KEY=
  S3_SECRET_KEY=
  S3_REGION=

- En el README, explica que **yo** pondré mis credenciales reales de MariaDB (host, user, pass) y que puedo usar el servicio Docker opcional si quiero.

### 2) Mapeo de tipos y constraints (MariaDB)
- Usa `VARCHAR(191)` para fields con índices únicos (por compatibilidad InnoDB).
- `TEXT`/`LONGTEXT` donde aplique (manuales content_html).
- Timestamps con `DATETIME(3)` y valores por defecto.
- Enums Prisma para estados (tareas, impuestos, visibilidad).
- Añade **índices**:
  - tasks: (visibilidad), (asignado_a), (cliente_id, estado), (fecha_vencimiento)
  - client_tax: (client_id, tax_period_id), (estado), (created_at)
  - manuals: (publicado), (categoria), (autor_id)
  - activity_logs: (usuario_id, modulo, fecha)
  - clients: (nif_cif unique), (responsable_asignado)
- FK ON DELETE/UPDATE adecuadas (CASCADE donde aplique: files de un client_tax, etc.)

### 3) Seeds y datos de ejemplo
- `npm run db:seed` debe crear:
  - 3 usuarios: admin/gestor/lectura (pass `admin123`)
  - 5 clientes (autónomos/empresas)
  - Modelos fiscales: 303, 390, 130, 131
  - Periodos 2024 y 2025
  - 5 tareas (mezcla GENERAL/PERSONAL)
  - 2 manuales
- Asegura que los seeds funcionan con MariaDB real y con el contenedor Docker.

### 4) Sustituir almacenamiento local y cron
- **Subidas**: cambia `/uploads` a almacenamiento **S3-compatible** (Backblaze/MinIO/AWS), validando MIME real con `file-type`, permitiendo sólo PDF/PNG/JPG/XLSX/DOCX, 10MB máx. Guarda **sólo la URL** y metadatos en BD.
- **Jobs**: reemplaza `setInterval` por `node-cron` (o Agenda) para:
  - Recordatorios de tareas (3 días antes).
  - Recordatorios de impuestos (7 días antes).
  - Registrar ejecuciones en `job_runs`.
- Añade comando `npm run jobs:start`.

### 5) Seguridad (auth y cabeceras)
- Migra autenticación: **cookies httpOnly + secure + SameSite=Lax**. 
- Añade **CSRF tokens** en endpoints mutadores y ajusta el frontend a `/auth/profile` para estado.
- Refuerza Helmet con **CSP estricta**:
  default-src 'self';
  img-src 'self' data: blob:;
  style-src 'self' 'unsafe-inline';
  script-src 'self';
  connect-src 'self';
  font-src 'self';
  frame-ancestors 'none';
- Mantén rate limiting y validaciones.

### 6) Logging y observabilidad
- Integra **pino** con rotación diaria a `/logs`, añade `request-id` por petición (async_hooks) y propágalo a `activity_logs` y a emails.
- Endpoints `/health` y `/ready`.

### 7) Docker + Nginx + Backups (MariaDB)
- Genera `/docker/docker-compose.yml` con servicios:
  - `api` (Node)
  - `web` (Nginx sirviendo build del frontend; proxy `/api` → api:5000; HSTS, gzip, rate-limit 30 r/s)
  - `db` (MariaDB 10.11+; volumen `./db_data`)
  - `jobs` (cron de notificaciones)
- Crea `Dockerfile.api`, `Dockerfile.web`, `docker/nginx.conf`.
- **Backups**: `scripts/backup.sh` con `mysqldump` diario (03:00), gzip y rotación 14 días a `/backups`; y `scripts/restore.sh`.
- Crea `README_DEPLOY.md` con pasos para VPS (Ubuntu): Docker, .env, `docker compose up -d`, DNS/SSL (puedes dejar plantilla para certbot o nginx-proxy).

### 8) Tests E2E
- Añade `@playwright/test` con casos mínimos:
  - Auth (login/roles)
  - CRUD clientes
  - Tareas (GENERAL/PERSONAL)
  - Subida/descarga de tax_files (simular S3 con MinIO local en dev si quieres)
  - Manuales (crear/editar con TipTap)
- Scripts:
  - `npm run e2e` para ejecutar los tests.
  - Si procede, añade workflow de CI simple (GitHub Actions).

### 9) Frontend (ajustes por auth y CORS)
- Actualiza el frontend para usar cookies (no localStorage) y flujo con `/auth/profile`.
- Asegura CORS para `FRONTEND_URL` y cookies cross-site si el dominio difiere (SameSite apropiado/secure en prod).

### 10) Entrega final
- Ejecuta migraciones y seed con MariaDB **dentro de Replit** usando un contenedor o MariaDB remoto temporal (si no puede, simula conexión pero deja todo el SQL y migraciones listas).
- **Genera**:
  - `/prisma/schema.prisma` (provider mysql).
  - `/prisma/migrations/*`
  - `/database/schema_mariadb.sql` con TODAS las tablas.
  - `.env.example` con `DATABASE_URL` de MySQL.
  - Scripts `db:*` en package.json.
  - `/docker/*` (compose, Dockerfiles, nginx.conf).
  - `/scripts/backup.sh` y `/scripts/restore.sh`.
  - `README_DEPLOY.md` con instrucciones VPS.
- Al terminar, **ejecuta los tests**, muestra:
  - Árbol de carpetas,
  - Comandos de despliegue,
  - Cómo conectar a mi propia MariaDB (`mysql://user:pass@host:3306/db`),
  - Y prepara el **ZIP final** para descargar.

### Además, aplica estos cambios exactos (copiar/pegar):

Realiza estos cambios en mi proyecto actual:

1) Autenticación con cookies httpOnly + SameSite=Lax; añade CSRF tokens y actualiza frontend para usar /auth/profile.
2) Refuerza Helmet con una CSP estricta (default-src 'self'; img data/blob; style 'self' 'unsafe-inline'; script 'self'; connect 'self'; font 'self'; frame-ancestors 'none').
3) Sustituye /uploads locales por S3-compatible (env S3_*) con validación MIME real (file-type) y límite de tipos PDF/PNG/JPG/XLSX/DOCX; guarda solo URLs en BD.
4) Reemplaza setInterval por node-cron: tareas (3 días antes) e impuestos (7 días antes), logueando ejecuciones.
5) Añade pino con rotación en /logs, request-id por petición, endpoints /health y /ready.
6) Crea /docker/docker-compose.yml, Dockerfile.api, Dockerfile.web y nginx.conf con reverse proxy /api, HSTS, gzip y rate-limit. Genera scripts/backup.sh y restore.sh, y README_DEPLOY.md con pasos del VPS.
7) Añade @playwright/test con pruebas e2e mínimas (auth, clientes, tareas, archivos, manuales) y npm run e2e.

Cuando termines, ejecuta los tests, muestra los comandos de despliegue y prepara el ZIP final para descargar.